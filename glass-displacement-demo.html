<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glass Displacement Demo</title>
    <style>
      @import url("https://unpkg.com/normalize.css") layer(normalize);
      @import url("https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap");

      @layer normalize, base, demo;

      @layer demo {
        :root {
          --content-width: 720px;
          scrollbar-color: canvasText #0000;
        }

        section p {
          line-height: 1.5;
        }

        .emojis {
          --font-level: 4;
          display: flex;
          gap: 1rem;
          flex-wrap: wrap;
        }

        .arrow {
          display: inline-block;
          opacity: 0.8;
          position: absolute;
          font-size: 0.875rem;
          font-family: "Gloria Hallelujah", cursive;
          transition: opacity 0.26s ease-out;
        }

        .arrow.arrow--debug {
          top: 140px;
          left: 30%;
          translate: -100% 0;
          width: 80px;
        }

        .arrow.arrow--debug span {
          display: inline-block;
          rotate: -24deg;
          translate: 0 100%;
        }

        .arrow.arrow--debug svg {
          translate: 80% -80%;
          rotate: -25deg;
          left: 0%;
          width: 100%;
        }

        .filter {
          width: 100%;
          height: 100%;
          pointer-events: none;
          position: absolute;
          inset: 0;
        }

        :is(header, main) {
          width: var(--content-width);
          max-width: calc(100vw - 2rem);
          margin: 0 auto;
        }

        section {
          margin-block: 4rem;
        }

        .images {
          display: flex;
          flex-direction: column;
          gap: 2rem;
        }

        .images img {
          width: 300px;
        }

        footer {
          padding: 1rem;
          text-align: center;
          font-size: 0.875rem;
          opacity: 0.7;
        }

        header {
          margin-block: 4rem;
        }

        header p {
          --font-level: 2;
          text-wrap: balance;
          color: color-mix(in oklch, canvasText, canvas 35%);
        }

        main {
          flex: 1;
        }

        main img {
          border-radius: 12px;
        }

        .apps {
          display: grid;
          grid-template-columns: repeat(4, 80px);
          gap: 1rem;
        }

        .app {
          width: 80px;
          font-size: 0.875rem;
          font-weight: 300;
        }

        .app span {
          display: block;
          text-align: center;
          white-space: nowrap;
        }

        .app img {
          width: 100%;
        }

        .nav-wrap {
          width: 100%;
          height: 100%;
          overflow: hidden;
          border-radius: inherit;
        }

        [data-icons="true"] .effect nav {
          opacity: 1;
        }

        [data-mode="dock"] .effect {
          backdrop-filter: url(#filter) brightness(1.1) saturate(1.5);
        }

        .effect nav {
          width: 100%;
          height: 100%;
          flex-wrap: wrap;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0.4rem;
          opacity: 0;
          overflow: hidden;
          border-radius: inherit;
          transition: opacity 0.26s ease-out;
        }

        .effect nav img {
          width: 80px;
          aspect-ratio: 1;
        }

        .effect {
          opacity: 0;
          transition: opacity 0.26s ease-out;
          height: calc(var(--height) * 1px);
          width: calc(var(--width) * 1px);
          border-radius: calc(var(--radius) * 1px);
          position: fixed;
          z-index: 999999;
          background: light-dark(
            hsl(0 0% 100% / var(--frost, 0)),
            hsl(0 0% 0% / var(--frost, 0))
          );
          backdrop-filter: url(#filter) saturate(var(--saturation, 1));
          box-shadow:
            0 0 2px 1px
              light-dark(
                color-mix(in oklch, canvasText, #0000 85%),
                color-mix(in oklch, canvasText, #0000 65%)
              )
              inset,
            0 0 10px 4px
              light-dark(
                color-mix(in oklch, canvasText, #0000 90%),
                color-mix(in oklch, canvasText, #0000 85%)
              )
              inset,
            0 4px 16px rgba(17, 17, 26, 0.05),
            0 8px 24px rgba(17, 17, 26, 0.05),
            0 16px 56px rgba(17, 17, 26, 0.05),
            0 4px 16px rgba(17, 17, 26, 0.05) inset,
            0 8px 24px rgba(17, 17, 26, 0.05) inset,
            0 16px 56px rgba(17, 17, 26, 0.05) inset;
        }

        .effect * {
          pointer-events: none;
        }

        .placeholder {
          width: 336px;
          height: 96px;
          max-width: 100%;
          position: relative;
          margin-bottom: 200px;
        }

        .dock-placeholder {
          width: 336px;
          height: 96px;
          border-radius: 16px;
          position: absolute;
          top: 50%;
          left: 50%;
          translate: -50% -50%;
        }

        [data-debug="true"] .displacement-debug {
          translate: 0 calc(100% + 1rem);
          scale: 1;
          opacity: 1;
        }

        .displacement-debug {
          pointer-events: none;
          height: 100%;
          width: 100%;
          position: absolute;
          inset: 0;
          translate: 0 calc(200% + 1rem);
          scale: 0.8;
          opacity: 0;
          transition-property: translate, opacity, scale;
          transition-duration: 0.26s;
          transition-timing-function: ease-out;
          z-index: -1;
        }

        .displacement-debug .label {
          position: absolute;
          left: 50%;
          top: calc(100% + 0.2lh);
        }

        .displacement-debug .label span {
          display: inline-block;
          font-size: 0.875rem;
          font-family: "Gloria Hallelujah", cursive;
          padding: 0.5rem 0.75rem;
          background: color-mix(in oklch, canvas, #0000 25%);
          backdrop-filter: blur(4px);
          border-radius: 6px;
          white-space: nowrap;
        }

        .displacement-debug .label svg {
          position: absolute;
          filter: drop-shadow(0 2px 10px canvas);
          right: 100%;
          rotate: 40deg;
          translate: 25% 60%;
          scale: -1 1;
          width: 40px;
        }

        .displacement-debug .displacement-image {
          height: 100%;
          width: 100%;
          pointer-events: none;
          border-radius: calc(var(--radius) * 1px);
        }

        h1 {
          --font-level: 6;
          line-height: 0.9;
          margin: 0;
          margin-bottom: 0.25lh;
        }
      }

      @layer base {
        :root {
          --font-size-min: 16;
          --font-size-max: 20;
          --font-ratio-min: 1.2;
          --font-ratio-max: 1.33;
          --font-width-min: 375;
          --font-width-max: 1500;
        }

        html {
          color-scheme: light dark;
        }

        [data-theme="light"] {
          color-scheme: light only;
        }

        [data-theme="dark"] {
          color-scheme: dark only;
        }

        :where(.fluid) {
          --fluid-min: calc(
            var(--font-size-min) * pow(var(--font-ratio-min), var(--font-level, 0))
          );
          --fluid-max: calc(
            var(--font-size-max) * pow(var(--font-ratio-max), var(--font-level, 0))
          );
          --fluid-preferred: calc(
            (var(--fluid-max) - var(--fluid-min)) /
              (var(--font-width-max) - var(--font-width-min))
          );
          --fluid-type: clamp(
            (var(--fluid-min) / 16) * 1rem,
            ((var(--fluid-min) / 16) * 1rem) -
              (((var(--fluid-preferred) * var(--font-width-min)) / 16) * 1rem) +
              (var(--fluid-preferred) * var(--variable-unit, 100vi)),
            (var(--fluid-max) / 16) * 1rem
          );
          font-size: var(--fluid-type);
        }

        *,
        *:after,
        *:before {
          box-sizing: border-box;
        }

        body {
          background: light-dark(#fff, #000);
          overflow-x: hidden;
          min-height: 100vh;
          font-family:
            "SF Pro Text",
            "SF Pro Icons",
            "AOS Icons",
            "Helvetica Neue",
            Helvetica,
            Arial,
            sans-serif,
            system-ui;
        }

        body::before {
          --size: 45px;
          --line: color-mix(in hsl, canvasText, transparent 80%);
          content: "";
          height: 100vh;
          width: 100vw;
          position: fixed;
          background:
            linear-gradient(90deg, var(--line) 1px, transparent 1px var(--size))
              calc(var(--size) * 0.36) 50% / var(--size) var(--size),
            linear-gradient(var(--line) 1px, transparent 1px var(--size)) 0%
              calc(var(--size) * 0.32) / var(--size) var(--size);
          mask: linear-gradient(-20deg, transparent 50%, white);
          top: 0;
          transform-style: flat;
          pointer-events: none;
          z-index: -1;
        }

        .bear-link {
          color: canvasText;
          position: fixed;
          top: 1rem;
          left: 1rem;
          width: 48px;
          aspect-ratio: 1;
          display: grid;
          place-items: center;
          opacity: 0.8;
        }

        :where(.x-link, .bear-link):is(:hover, :focus-visible) {
          opacity: 1;
        }

        .bear-link svg {
          width: 75%;
        }
      }

      [data-top="true"] div.tp-dfwv {
        top: 8px;
      }

      div.tp-dfwv {
        position: fixed;
        width: 280px;
        bottom: 8px;
        top: unset;
        view-transition-name: pane;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="fluid">
        glass
        <br />
        displacement
      </h1>
      <p class="fluid">
        it's not perfect, but neither is the platform.
        <br />
        we love it anyway.
      </p>
    </header>
    <div class="effect">
      <div class="nav-wrap">
        <nav>
          <img src="https://assets.codepen.io/605876/finder.png" alt="" />
          <img src="https://assets.codepen.io/605876/launch-control.png" alt="" />
          <img src="https://assets.codepen.io/605876/safari.png" alt="" />
          <img src="https://assets.codepen.io/605876/calendar.png" alt="" />
        </nav>
      </div>
      <svg class="filter" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="filter" color-interpolation-filters="sRGB">
            <feImage x="0" y="0" width="100%" height="100%" result="map"></feImage>
            <feDisplacementMap
              in="SourceGraphic"
              in2="map"
              id="redchannel"
              xChannelSelector="R"
              yChannelSelector="G"
              result="dispRed"
            />
            <feColorMatrix
              in="dispRed"
              type="matrix"
              values="1 0 0 0 0
                      0 0 0 0 0
                      0 0 0 0 0
                      0 0 0 1 0"
              result="red"
            />
            <feDisplacementMap
              in="SourceGraphic"
              in2="map"
              id="greenchannel"
              xChannelSelector="R"
              yChannelSelector="G"
              result="dispGreen"
            />
            <feColorMatrix
              in="dispGreen"
              type="matrix"
              values="0 0 0 0 0
                      0 1 0 0 0
                      0 0 0 0 0
                      0 0 0 1 0"
              result="green"
            />
            <feDisplacementMap
              in="SourceGraphic"
              in2="map"
              id="bluechannel"
              xChannelSelector="R"
              yChannelSelector="G"
              result="dispBlue"
            />
            <feColorMatrix
              in="dispBlue"
              type="matrix"
              values="0 0 0 0 0
                      0 0 0 0 0
                      0 0 1 0 0
                      0 0 0 1 0"
              result="blue"
            />
            <feBlend in="red" in2="green" mode="screen" result="rg" />
            <feBlend in="rg" in2="blue" mode="screen" result="output" />
            <feGaussianBlur in="output" stdDeviation="0.7" />
          </filter>
        </defs>
      </svg>
      <div class="displacement-debug"></div>
    </div>
    <main>
      <section class="placeholder">
        <div class="dock-placeholder"></div>
        <span class="arrow arrow--debug"><span>drag, scroll, configure</span></span>
      </section>
      <section>
        <p class="fluid">
          How do you create backdrop displacement with HTML and CSS? SVG. The idea is that you need a
          displacement map that distorts the input image. In this case, the backdrop of our element
          (whatever is underneath).
        </p>
      </section>
      <section>
        <div class="apps">
          <div class="app"><img src="https://assets.codepen.io/605876/beeper.png" alt="" /><span>Beeper</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/cursor.png" alt="" /><span>Cursor</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/screenstudio.png" alt="" /><span>Screen Studio</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/raycast.png" alt="" /><span>Raycast</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/photos.png" alt="" /><span>Photos</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/signal.png" alt="" /><span>Signal</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/spotify.png" alt="" /><span>Spotify</span></div>
          <div class="app"><img src="https://assets.codepen.io/605876/brave.png" alt="" /><span>Brave</span></div>
        </div>
      </section>
      <section>
        <p class="fluid">
          Check the "debug" option to see the displacement map used and play with the options. The red and blue
          of the displacement map displaces the backdrop. The caveats? You need to update the map image whenever
          the shape of the element changes. The big one? backdrop-filter: url() currently only works in Chromium
          and not Gecko/Webkit.
        </p>
      </section>
      <section class="emojis fluid">
        <span>üßë‚Äçüç≥</span><span>ü§ì</span><span>ü§™</span><span>üôÑ</span><span>ü§†</span><span>ü•∏</span>
      </section>
      <section>
        <p class="fluid">
          Glass adjusts for different surfaces and use cases.
          <br />
          Try different modes or freestyle it in "free" mode.
        </p>
      </section>
      <section class="images">
        <img src="https://fastly.picsum.photos/id/841/300/300.jpg?hmac=59ZNBwU1FjRrwpU3J7NDerfr_DHq-JPYXqnyumDt17U" alt="" />
        <img src="https://fastly.picsum.photos/id/517/300/300.jpg?hmac=xDY76wxtwOZ5mEJYjf_i69VkVQibAYi036aADsWbaLs" alt="" />
        <img src="https://fastly.picsum.photos/id/204/300/300.jpg?hmac=nMn3k2irZFRlOEdAxFaKapzdO5cuwF8eQv5HbhP9Lyw" alt="" />
        <img src="https://fastly.picsum.photos/id/906/300/300.jpg?hmac=UJKxYXpNPOY5aqp_mipycmJFPgr8bd3RxcZChdDu0-c" alt="" />
        <img src="https://fastly.picsum.photos/id/546/300/300.jpg?hmac=f8E2wXr3kthnt3BT6h17Y5Baf_0aJUdPIV7GqBVgxzY" alt="" />
      </section>
      <section>
        <p class="fluid">
          That's it. Go forth and play with SVG filters.
          <br />
          But maybe do it in Safari and Firefox first.
        </p>
      </section>
    </main>
    <footer>‚î¨‚î¥‚î¨‚î¥‚î§‚Ä¢·¥•‚Ä¢ î jhey &copy; 2025 ‚îú‚î¨‚î¥‚î¨‚î¥</footer>

    <script type="module">
      import { Pane } from "https://cdn.skypack.dev/tweakpane@4.0.4";
      import gsap from "https://cdn.skypack.dev/gsap@3.13.0";
      import Draggable from "https://cdn.skypack.dev/gsap@3.13.0/Draggable";
      gsap.registerPlugin(Draggable);

      const base = {
        icons: false,
        scale: -180,
        radius: 16,
        border: 0.07,
        lightness: 50,
        displace: 0,
        blend: "difference",
        x: "R",
        y: "B",
        alpha: 0.93,
        blur: 11,
        r: 0,
        g: 10,
        b: 20,
        saturation: 1
      };

      const presets = {
        dock: { ...base, width: 336, height: 96, displace: 0.2, icons: true, frost: 0.05 },
        pill: { ...base, width: 200, height: 80, displace: 0, frost: 0, radius: 40 },
        bubble: { ...base, radius: 70, width: 140, height: 140, displace: 0, frost: 0 },
        free: {
          ...base,
          width: 140,
          height: 280,
          radius: 80,
          border: 0.15,
          alpha: 0.74,
          lightness: 60,
          blur: 10,
          displace: 0,
          scale: -300
        }
      };

      const config = {
        ...presets.dock,
        theme: "system",
        debug: false,
        top: false,
        preset: "dock"
      };

      const ctrl = new Pane({ title: "config", expanded: true });
      const debugPen = document.querySelector(".displacement-debug");

      const buildDisplacementImage = () => {
        const border = Math.min(config.width, config.height) * (config.border * 0.5);
        const kids = `
          <svg class="displacement-image" viewBox="0 0 ${config.width} ${config.height}" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="red" x1="100%" y1="0%" x2="0%" y2="0%">
                <stop offset="0%" stop-color="#000"/>
                <stop offset="100%" stop-color="red"/>
              </linearGradient>
              <linearGradient id="blue" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#000"/>
                <stop offset="100%" stop-color="blue"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="${config.width}" height="${config.height}" fill="black"></rect>
            <rect x="0" y="0" width="${config.width}" height="${config.height}" rx="${config.radius}" fill="url(#red)" />
            <rect x="0" y="0" width="${config.width}" height="${config.height}" rx="${config.radius}" fill="url(#blue)" style="mix-blend-mode:${config.blend}" />
            <rect
              x="${border}"
              y="${border}"
              width="${config.width - border * 2}"
              height="${config.height - border * 2}"
              rx="${config.radius}"
              fill="hsl(0 0% ${config.lightness}% / ${config.alpha})"
              style="filter:blur(${config.blur}px)"
            />
          </svg>
          <div class="label"><span>displacement image</span></div>
        `;

        debugPen.innerHTML = kids;

        const svgEl = debugPen.querySelector(".displacement-image");
        const serialized = new XMLSerializer().serializeToString(svgEl);
        const dataUri = `data:image/svg+xml,${encodeURIComponent(serialized)}`;

        gsap.set("feImage", { attr: { href: dataUri } });
        gsap.set("feDisplacementMap", {
          attr: { xChannelSelector: config.x, yChannelSelector: config.y }
        });
      };

      const update = () => {
        buildDisplacementImage();
        gsap.set(document.documentElement, {
          "--width": config.width,
          "--height": config.height,
          "--radius": config.radius,
          "--frost": config.frost,
          "--output-blur": config.displace,
          "--saturation": config.saturation
        });
        gsap.set("feDisplacementMap", { attr: { scale: config.scale } });
        gsap.set("#redchannel", { attr: { scale: config.scale + config.r } });
        gsap.set("#greenchannel", { attr: { scale: config.scale + config.g } });
        gsap.set("#bluechannel", { attr: { scale: config.scale + config.b } });
        gsap.set("feGaussianBlur", { attr: { stdDeviation: config.displace } });

        document.documentElement.dataset.icons = config.icons;
        document.documentElement.dataset.mode = config.preset;
        document.documentElement.dataset.top = config.top;
        document.documentElement.dataset.debug = config.debug;
        document.documentElement.dataset.theme = config.theme;
      };

      const sync = (event) => {
        const label = event?.target?.controller?.view?.labelElement?.innerText;
        if (!document.startViewTransition || (label !== "theme" && label !== "top")) return update();
        document.startViewTransition(() => update());
      };

      ctrl.addBinding(config, "debug");
      ctrl.addBinding(config, "top");
      ctrl
        .addBinding(config, "preset", {
          label: "mode",
          options: { dock: "dock", pill: "pill", bubble: "bubble", free: "free" }
        })
        .on("change", () => {
          document.documentElement.dataset.mode = config.preset;
          settings.expanded = config.preset === "free";
          settings.disabled = config.preset !== "free";
          if (config.preset !== "free") {
            const values = presets[config.preset];
            document.documentElement.dataset.icons = values.icons;
            const morph = gsap.timeline({ onUpdate: () => ctrl.refresh() });
            for (const [key, value] of Object.entries(values)) morph.to(config, { [key]: value }, 0);
          }
        });

      ctrl.addBinding(config, "theme", {
        label: "theme",
        options: { system: "system", light: "light", dark: "dark" }
      });

      const settings = ctrl.addFolder({ title: "settings", disabled: true, expanded: false });
      settings.addBinding(config, "frost", { min: 0, max: 1, step: 0.01 });
      settings.addBinding(config, "saturation", { min: 0, max: 2, step: 0.1 });
      settings.addBinding(config, "icons");
      settings.addBinding(config, "width", { min: 80, max: 500, step: 1 });
      settings.addBinding(config, "height", { min: 35, max: 500, step: 1 });
      settings.addBinding(config, "radius", { min: 0, max: 500, step: 1 });
      settings.addBinding(config, "border", { min: 0, max: 1, step: 0.01 });
      settings.addBinding(config, "alpha", { min: 0, max: 1, step: 0.01 });
      settings.addBinding(config, "lightness", { min: 0, max: 100, step: 1 });
      settings.addBinding(config, "blur", { min: 0, max: 20, step: 1, label: "input blur" });
      settings.addBinding(config, "displace", { min: 0, max: 12, step: 0.1, label: "output blur" });
      settings.addBinding(config, "x", { options: { r: "R", g: "G", b: "B" } });
      settings.addBinding(config, "y", { options: { r: "R", g: "G", b: "B" } });
      settings.addBinding(config, "blend", {
        options: {
          normal: "normal",
          multiply: "multiply",
          screen: "screen",
          overlay: "overlay",
          darken: "darken",
          lighten: "lighten",
          "color-dodge": "color-dodge",
          "color-burn": "color-burn",
          "hard-light": "hard-light",
          "soft-light": "soft-light",
          difference: "difference",
          exclusion: "exclusion",
          hue: "hue",
          saturation: "saturation",
          color: "color",
          luminosity: "luminosity",
          "plus-darker": "plus-darker",
          "plus-lighter": "plus-lighter"
        }
      });
      settings.addBinding(config, "scale", { min: -1000, max: 1000, step: 1 });

      const abb = settings.addFolder({ title: "chromatic" });
      abb.addBinding(config, "r", { min: -100, max: 100, step: 1, label: "red" });
      abb.addBinding(config, "g", { min: -100, max: 100, step: 1, label: "green" });
      abb.addBinding(config, "b", { min: -100, max: 100, step: 1, label: "blue" });

      Draggable.create(".effect", { type: "x,y" });
      ctrl.on("change", sync);
      update();

      const { top, left } = document.querySelector(".dock-placeholder").getBoundingClientRect();
      gsap.set(".effect", {
        top: top > window.innerHeight ? window.innerHeight * 0.5 : top,
        left,
        opacity: 1
      });
    </script>
  </body>
</html>
